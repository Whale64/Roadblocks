<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Battle Dogs: 50 Levels of Fury</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
        
        body {
            font-family: 'Fredoka One', cursive;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        canvas {
            image-rendering: pixelated;
        }

        .btn-game {
            transition: all 0.1s;
            user-select: none;
            touch-action: manipulation;
        }
        
        .btn-game:active:not(:disabled) {
            transform: scale(0.95);
            filter: brightness(0.8);
        }

        .btn-game:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 4px;
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 10px;
        }

        .scanlines {
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.02) 50%,
                rgba(0,0,0,0.02)
            );
            background-size: 100% 4px;
            pointer-events: none;
        }

        /* Hide scrollbar but allow scrolling */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen w-screen flex flex-col items-center justify-center overflow-hidden">

    <div id="game-wrapper" class="relative w-full max-w-6xl aspect-[2/1] bg-sky-300 sm:rounded-2xl overflow-hidden shadow-[0_0_50px_rgba(0,0,0,0.5)] sm:border-8 border-gray-800">
        
        <canvas id="gameCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
        <div class="absolute top-0 left-0 w-full h-full scanlines"></div>

        <!-- UI: Top Bar -->
        <div class="absolute top-0 left-0 w-full p-2 sm:p-4 flex justify-between items-start pointer-events-none z-10">
            <div class="bg-black/50 p-1 sm:p-2 rounded-lg backdrop-blur-sm border border-white/20">
                <div class="text-[8px] sm:text-[10px] text-blue-300 mb-0.5">DOG HOUSE</div>
                <div class="w-20 sm:w-48 h-2 sm:h-4 bg-gray-700 rounded-full overflow-hidden">
                    <div id="player-hp-bar" class="h-full bg-blue-500 w-full transition-all duration-200"></div>
                </div>
            </div>

            <div class="bg-black/70 px-3 sm:px-6 py-1 sm:py-2 rounded-xl backdrop-blur-sm border-2 border-yellow-400/50 flex flex-col items-center shadow-lg transform scale-90 sm:scale-110">
                <div class="text-yellow-400 text-[8px] sm:text-[10px] tracking-widest uppercase mb-0.5">Bones</div>
                <div class="text-base sm:text-3xl font-bold flex items-center gap-1 sm:gap-2">
                    ü¶¥ <span id="money-display">0</span> <span class="text-[10px] sm:text-sm text-gray-400 font-normal">/ <span id="max-money-display">150</span></span>
                </div>
                <div class="text-[8px] sm:text-[10px] text-green-400">Miner Lvl <span id="worker-level-display">1</span></div>
            </div>

            <div class="bg-black/50 p-1 sm:p-2 rounded-lg backdrop-blur-sm border border-white/20 text-right">
                <div class="text-[8px] sm:text-[10px] text-red-300 mb-0.5">CAT TOWER</div>
                <div class="w-20 sm:w-48 h-2 sm:h-4 bg-gray-700 rounded-full overflow-hidden flex justify-end">
                    <div id="enemy-hp-bar" class="h-full bg-red-500 w-full transition-all duration-200"></div>
                </div>
            </div>
        </div>

        <!-- UI: Bottom Bar (Responsive Scrollable) -->
        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/90 to-black/40 pt-6 pb-2 sm:pb-4 px-2 flex gap-2 justify-start items-end z-10 overflow-x-auto scrollbar-hide">
            <button id="btn-upgrade" class="btn-game bg-green-600 hover:bg-green-500 border-b-4 border-green-800 rounded-xl p-2 flex flex-col items-center min-w-[65px] sm:min-w-[90px] flex-shrink-0">
                <div class="text-xl sm:text-2xl">‚õèÔ∏è</div>
                <div class="text-[8px] sm:text-[10px] leading-tight text-center text-green-200 mb-1 font-bold">UPGRADE</div>
                <div class="bg-black/50 px-1 sm:px-2 rounded text-[10px] sm:text-base font-bold text-yellow-300">ü¶¥ <span id="upgrade-cost">40</span></div>
            </button>
            <div class="w-0.5 h-10 bg-white/20 rounded-full self-center mx-1 flex-shrink-0"></div>
            <div id="unit-controls" class="flex gap-2 pb-1 pr-4">
                <!-- Unit buttons generated here -->
            </div>
        </div>

        <!-- Screens -->
        <div id="start-screen" class="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center backdrop-blur-md overflow-y-auto py-8">
            <h1 class="text-3xl sm:text-7xl text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 font-bold mb-2 drop-shadow-[0_5px_5px_rgba(0,0,0,1)] text-center px-4 leading-tight">BATTLE DOGS<br><span class="text-xl sm:text-4xl text-white">50 Levels of Fury</span></h1>
            
            <div class="flex flex-col lg:flex-row gap-4 w-full max-w-5xl px-4 mt-2">
                <div class="flex-1 bg-gray-800/80 p-4 sm:p-6 rounded-2xl border-4 border-yellow-500 flex flex-col items-center justify-center text-center shadow-2xl">
                    <h2 class="text-2xl sm:text-3xl font-bold text-white mb-1">Level <span id="menu-level-display">1</span> / 50</h2>
                    <div id="boss-warning" class="text-red-500 font-bold animate-pulse hidden mb-1 text-lg sm:text-xl">‚ö†Ô∏è BOSS ENCOUNTER ‚ö†Ô∏è</div>
                    <p class="text-gray-300 mb-4 text-xs sm:text-base" id="level-flavor-text">Prepare for the Cat Legion's return.</p>
                    <button id="btn-start" class="btn-game bg-yellow-500 hover:bg-yellow-400 text-black px-8 py-3 rounded-full text-xl sm:text-2xl font-bold border-b-6 border-yellow-700 shadow-xl w-full max-w-xs">BATTLE!</button>
                </div>

                <div class="flex-1 bg-gray-800/80 p-4 rounded-2xl border-4 border-blue-500 flex flex-col items-center shadow-2xl">
                    <h2 class="text-xl font-bold text-white mb-2">Barracks Shop</h2>
                    <div class="bg-black/50 px-3 py-1 rounded-lg mb-2 text-sm sm:text-lg font-bold text-yellow-300 border border-yellow-500/50">
                        üêæ Paws: <span id="menu-paws-display">0</span>
                    </div>
                    <div id="shop-items" class="grid grid-cols-2 gap-2 w-full max-h-[35vh] sm:max-h-[45vh] overflow-y-auto pr-1 custom-scrollbar"></div>
                </div>
            </div>
        </div>

        <div id="game-over-screen" class="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center backdrop-blur-md hidden p-4">
            <h1 id="game-over-title" class="text-5xl sm:text-8xl font-bold mb-2 drop-shadow-[0_5px_5px_rgba(0,0,0,1)] text-center text-white">VICTORY!</h1>
            <p id="game-over-desc" class="text-lg sm:text-2xl text-gray-300 mb-6 text-center"></p>
            <button id="btn-restart" class="btn-game bg-white hover:bg-gray-200 text-black px-10 py-3 rounded-full text-xl sm:text-2xl font-bold border-b-6 border-gray-400 shadow-xl">CONTINUE</button>
        </div>

    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const GAME_WIDTH = 1200;
        const GAME_HEIGHT = 600;
        canvas.width = GAME_WIDTH;
        canvas.height = GAME_HEIGHT;
        const GROUND_Y = 480;

        // UI Refs
        const moneyDisplay = document.getElementById('money-display');
        const maxMoneyDisplay = document.getElementById('max-money-display');
        const workerLevelDisplay = document.getElementById('worker-level-display');
        const upgradeCostDisplay = document.getElementById('upgrade-cost');
        const btnUpgrade = document.getElementById('btn-upgrade');
        const playerHpBar = document.getElementById('player-hp-bar');
        const enemyHpBar = document.getElementById('enemy-hp-bar');
        const unitControlsContainer = document.getElementById('unit-controls');
        const menuLevelDisplay = document.getElementById('menu-level-display');
        const bossWarning = document.getElementById('boss-warning');
        const menuPawsDisplay = document.getElementById('menu-paws-display');
        const shopItemsContainer = document.getElementById('shop-items');
        const levelFlavorText = document.getElementById('level-flavor-text');
        
        const screens = {
            start: document.getElementById('start-screen'),
            gameOver: document.getElementById('game-over-screen'),
            title: document.getElementById('game-over-title'),
            desc: document.getElementById('game-over-desc')
        };

        // State
        let savedState = JSON.parse(localStorage.getItem('battleDogsSaveV5')) || {
            level: 1,
            paws: 0,
            unlocked: [0, 1]
        };
        let currentLevel = savedState.level;
        let goldenPaws = savedState.paws;
        let unlockedTroops = savedState.unlocked;

        let gameState = 'START';
        let lastTime = 0;
        let money = 0;
        let maxMoney = 150;
        let moneyRate = 12;
        let workerLevel = 1;
        let workerUpgradeCost = 40;
        
        let units = [];
        let particles = [];
        let damageTexts = [];
        let enemySpawnTimer = 0;
        let gameTime = 0;

        const UNIT_TYPES = {
            PLAYER: [
                { id: 0, name: 'Basic', emoji: 'üêï', cost: 50, hp: 140, damage: 20, range: 45, speed: 1.5, attackSpeed: 1.1, size: 75, color: '#3b82f6', unlockCost: 0 },
                { id: 1, name: 'Tank',  emoji: 'ü¶Æ', cost: 160, hp: 700, damage: 15, range: 45, speed: 0.8, attackSpeed: 1.5, size: 90, color: '#60a5fa', unlockCost: 0 },
                { id: 2, name: 'Ninja', emoji: 'üêï‚Äçü¶∫', cost: 200, hp: 130, damage: 55, range: 50, speed: 2.8, attackSpeed: 0.6, size: 80, color: '#1e3a8a', unlockCost: 5 },
                { id: 3, name: 'Sniper',emoji: 'üê©', cost: 400, hp: 100, damage: 120, range: 400, speed: 1.0, attackSpeed: 2.5, size: 75, color: '#93c5fd', unlockCost: 10 },
                { id: 4, name: 'Cyber', emoji: 'ü§ñ', cost: 650, hp: 550, damage: 70, range: 160, speed: 1.2, attackSpeed: 1.0, size: 85, color: '#0ea5e9', unlockCost: 15 },
                { id: 5, name: 'Wizard',emoji: 'üßô', cost: 850, hp: 350, damage: 180, range: 280, speed: 0.9, attackSpeed: 2.0, size: 80, color: '#8b5cf6', unlockCost: 20 },
                { id: 6, name: 'Rocket',emoji: 'üöÄ', cost: 1100, hp: 250, damage: 350, range: 450, speed: 1.1, attackSpeed: 4.0, size: 85, color: '#f97316', unlockCost: 30 },
                { id: 7, name: 'Samurai',emoji: '‚öîÔ∏è', cost: 1300, hp: 1400, damage: 220, range: 60, speed: 1.5, attackSpeed: 0.8, size: 100, color: '#ef4444', unlockCost: 45 },
                { id: 8, name: 'Ghost', emoji: 'üëª', cost: 1500, hp: 800, damage: 150, range: 70, speed: 2.0, attackSpeed: 1.0, size: 80, color: '#cbd5e1', unlockCost: 60 },
                { id: 9, name: 'Mecha', emoji: 'ü¶æ', cost: 2500, hp: 5000, damage: 300, range: 110, speed: 0.7, attackSpeed: 2.2, size: 145, color: '#64748b', unlockCost: 80 },
                { id: 10, name: 'Fire',  emoji: 'üî•', cost: 3000, hp: 3500, damage: 500, range: 90, speed: 1.2, attackSpeed: 1.5, size: 110, color: '#f97316', unlockCost: 100 },
                { id: 11, name: 'Frost', emoji: '‚ùÑÔ∏è', cost: 3500, hp: 4000, damage: 400, range: 200, speed: 1.0, attackSpeed: 1.8, size: 110, color: '#38bdf8', unlockCost: 120 },
                { id: 12, name: 'Laser', emoji: 'üî´', cost: 4500, hp: 2000, damage: 900, range: 500, speed: 0.8, attackSpeed: 3.0, size: 100, color: '#4ade80', unlockCost: 150 },
                { id: 13, name: 'King',  emoji: 'üëë', cost: 6000, hp: 12000, damage: 1000, range: 120, speed: 0.5, attackSpeed: 2.5, size: 180, color: '#fbbf24', unlockCost: 200 },
                { id: 14, name: 'Deity', emoji: 'üëº', cost: 8000, hp: 20000, damage: 2500, range: 300, speed: 0.6, attackSpeed: 4.0, size: 200, color: '#fff', unlockCost: 350 },
                { id: 15, name: 'Galaxy',emoji: 'üåå', cost: 10000, hp: 50000, damage: 5000, range: 150, speed: 0.4, attackSpeed: 5.0, size: 250, color: '#5b21b6', unlockCost: 500 }
            ],
            ENEMY: [
                { id: 0, name: 'Kitten', emoji: 'üêà', hp: 110, damage: 15, range: 45, speed: 1.3, attackSpeed: 1.0, size: 65, color: '#ef4444' },
                { id: 1, name: 'Tabby', emoji: 'üêÖ', hp: 550, damage: 22, range: 50, speed: 0.8, attackSpeed: 1.6, size: 85, color: '#b91c1c' },
                { id: 2, name: 'Cheetah', emoji: 'üêÜ', hp: 90, damage: 14, range: 40, speed: 3.2, attackSpeed: 0.6, size: 70, color: '#dc2626' },
                { id: 3, name: 'Cyber', emoji: 'ü§ñ', hp: 3000, damage: 90, range: 140, speed: 1.1, attackSpeed: 1.5, size: 95, color: '#444' },
                { id: 4, name: 'Shadow', emoji: 'ü•∑', hp: 800, damage: 250, range: 50, speed: 3.5, attackSpeed: 0.7, size: 75, color: '#000' },
                { id: 5, name: 'Hell', emoji: 'üî•', hp: 8000, damage: 450, range: 80, speed: 1.3, attackSpeed: 1.2, size: 110, color: '#ea580c' },
                { id: 6, name: 'Gatling', emoji: 'üî´', hp: 4000, damage: 150, range: 450, speed: 0.7, attackSpeed: 0.5, size: 90, color: '#166534' },
                { id: 7, name: 'Void', emoji: 'üßø', hp: 25000, damage: 800, range: 120, speed: 0.6, attackSpeed: 2.0, size: 150, color: '#4c1d95' },
                { id: 8, name: 'Plasma', emoji: '‚ö°', hp: 12000, damage: 1200, range: 250, speed: 1.5, attackSpeed: 2.5, size: 120, color: '#06b6d4' },
                { id: 9, name: 'Arch', emoji: 'üëÅÔ∏è', hp: 60000, damage: 3000, range: 100, speed: 0.9, attackSpeed: 1.8, size: 180, color: '#fefce8' },
                { id: 10, name: 'Lord', emoji: 'üëπ', hp: 150000, damage: 5000, range: 60, speed: 0.5, attackSpeed: 3.0, size: 220, color: '#450a0a' },
                { id: 11, name: 'General', emoji: 'ü¶Å', hp: 15000, damage: 300, range: 100, speed: 0.5, attackSpeed: 2.0, size: 200, color: '#facc15' },
                { id: 12, name: 'Menace', emoji: 'üöú', hp: 50000, damage: 800, range: 120, speed: 0.4, attackSpeed: 2.5, size: 230, color: '#94a3b8' },
                { id: 13, name: 'Overlord', emoji: 'üßô‚Äç‚ôÇÔ∏è', hp: 150000, damage: 2000, range: 300, speed: 0.3, attackSpeed: 4.0, size: 250, color: '#1e1b4b' },
                { id: 14, name: 'Eater', emoji: 'üêâ', hp: 400000, damage: 4500, range: 200, speed: 0.2, attackSpeed: 5.0, size: 350, color: '#111827' },
                { id: 15, name: 'GOD', emoji: '‚õ©Ô∏è', hp: 2000000, damage: 15000, range: 150, speed: 0.1, attackSpeed: 8.0, size: 500, color: '#fff' }
            ]
        };

        const BASES = {
            player: { x: 80, y: GROUND_Y - 100, width: 140, height: 180, hp: 1000, maxHp: 1000, emoji: 'üè†', isEnemy: false },
            enemy: { x: GAME_WIDTH - 220, y: GROUND_Y - 100, width: 140, height: 180, hp: 1000, maxHp: 1000, emoji: 'üé™', isEnemy: true }
        };

        class Unit {
            constructor(typeData, isEnemy) {
                this.isEnemy = isEnemy;
                this.name = typeData.name;
                this.emoji = typeData.emoji;
                this.maxHp = typeData.hp;
                this.hp = this.maxHp;
                this.damage = typeData.damage;
                this.range = typeData.range;
                this.speed = typeData.speed * (isEnemy ? -1 : 1);
                this.attackSpeed = typeData.attackSpeed;
                this.size = typeData.size;
                this.color = typeData.color;
                this.y = GROUND_Y - this.size / 2 + (Math.random() * 40 - 20);
                this.x = isEnemy ? BASES.enemy.x : BASES.player.x + BASES.player.width;
                this.state = 'MOVING';
                this.attackCooldown = 0;
                this.animationTimer = Math.random() * 100;
            }

            takeDamage(amount) {
                this.hp -= amount;
                spawnDamageText(this.x, this.y - this.size/2, amount, this.isEnemy);
                if (this.hp <= 0) {
                    const count = Math.min(15, Math.ceil(this.size / 15));
                    for(let i=0; i<count; i++) particles.push(new Particle(this.x, this.y, this.emoji));
                    if (this.isEnemy) {
                        let bounty = Math.floor(Math.sqrt(this.maxHp) * 3.5);
                        money = Math.min(maxMoney, money + bounty);
                        spawnDamageText(this.x, this.y - 40, `+${bounty}`, false, '#fbbf24');
                    }
                }
            }

            update(dt) {
                if (this.hp <= 0) return;
                this.animationTimer += dt * 10;
                if (this.attackCooldown > 0) this.attackCooldown -= dt;

                let target = null;
                let closestDist = Infinity;
                let enemyBase = this.isEnemy ? BASES.player : BASES.enemy;
                let distToBase = this.isEnemy ? (this.x - (enemyBase.x + enemyBase.width)) : (enemyBase.x - this.x);

                if (distToBase >= 0) {
                    closestDist = distToBase;
                    target = enemyBase;
                }

                for (let u of units) {
                    if (u.isEnemy !== this.isEnemy && u.hp > 0) {
                        let dist = this.isEnemy ? (this.x - u.x) : (u.x - this.x);
                        if (dist >= 0 && dist < closestDist) {
                            closestDist = dist;
                            target = u;
                        }
                    }
                }

                let actualRange = this.range + (target && target.size ? target.size/2 : 0) + this.size/2;

                if (target && closestDist <= actualRange) {
                    this.state = 'ATTACKING';
                    if (this.attackCooldown <= 0) {
                        if (target.takeDamage) target.takeDamage(this.damage);
                        else target.hp -= this.damage; 
                        this.attackCooldown = this.attackSpeed;
                    }
                } else {
                    this.state = 'MOVING';
                    this.x += this.speed * dt * 60;
                }
            }

            draw(ctx) {
                if (this.hp <= 0) return;
                ctx.save();
                ctx.translate(this.x, this.y);
                let yOffset = this.state === 'MOVING' ? Math.sin(this.animationTimer) * 5 : 0;
                if (!this.isEnemy) ctx.scale(-1, 1);
                ctx.font = `${this.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.emoji, 0, yOffset);
                ctx.restore();

                const barWidth = Math.max(this.size, 40);
                const hpPercent = Math.max(0, this.hp / this.maxHp);
                ctx.fillStyle = '#111';
                ctx.fillRect(this.x - barWidth/2, this.y - this.size/2 - 15, barWidth, 6);
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x - barWidth/2, this.y - this.size/2 - 15, barWidth * hpPercent, 6);
            }
        }

        class Particle {
            constructor(x, y, emoji) {
                this.x = x; this.y = y; this.emoji = emoji;
                this.vx = (Math.random() - 0.5) * 12;
                this.vy = (Math.random() - 1) * 12;
                this.life = 1.0;
                this.size = 15 + Math.random() * 15;
                this.rot = Math.random() * Math.PI * 2;
            }
            update(dt) { this.vy += 30 * dt; this.x += this.vx; this.y += this.vy; this.life -= dt * 2; }
            draw(ctx) {
                ctx.save(); ctx.globalAlpha = Math.max(0, this.life);
                ctx.translate(this.x, this.y); ctx.rotate(this.rot);
                ctx.font = `${this.size}px Arial`; ctx.fillText(this.emoji, 0, 0);
                ctx.restore();
            }
        }

        class DamageText {
            constructor(x, y, amount, isPlayerDamage, customColor) {
                this.x = x; this.y = y; this.amount = amount;
                this.color = customColor || (isPlayerDamage ? '#ef4444' : '#ffffff');
                this.life = 1.0;
            }
            update(dt) { this.y -= 40 * dt; this.life -= dt * 1.6; }
            draw(ctx) {
                ctx.save(); ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color; ctx.font = "bold 20px Arial";
                ctx.textAlign = 'center'; ctx.fillText(typeof this.amount === 'number' ? Math.floor(this.amount) : this.amount, this.x, this.y);
                ctx.restore();
            }
        }

        function saveGame() {
            localStorage.setItem('battleDogsSaveV5', JSON.stringify({
                level: currentLevel, paws: goldenPaws, unlocked: unlockedTroops
            }));
            updateMenuUI();
        }

        function updateMenuUI() {
            menuLevelDisplay.textContent = currentLevel;
            const isBoss = currentLevel % 10 === 0;
            bossWarning.classList.toggle('hidden', !isBoss);
            
            if (currentLevel < 11) levelFlavorText.textContent = "Kitten Brigade Incoming.";
            else if (currentLevel < 21) levelFlavorText.textContent = "Cybernetic reinforcements detected.";
            else if (currentLevel < 31) levelFlavorText.textContent = "Infernal Cats from the void.";
            else if (currentLevel < 41) levelFlavorText.textContent = "Reality itself is bending.";
            else if (currentLevel < 51) levelFlavorText.textContent = "Godhood awaits the victor.";

            menuPawsDisplay.textContent = goldenPaws;
            shopItemsContainer.innerHTML = '';
            UNIT_TYPES.PLAYER.forEach((unit, idx) => {
                const isUnlocked = unlockedTroops.includes(idx);
                const btn = document.createElement('button');
                btn.className = `p-2 rounded-xl flex items-center gap-2 text-left transition-all ${isUnlocked ? 'bg-blue-900/30 border-2 border-blue-500' : 'bg-gray-800 border-2 border-gray-600 active:bg-gray-700'}`;
                btn.innerHTML = `
                    <div class="text-2xl sm:text-3xl ${isUnlocked ? '' : 'filter grayscale opacity-40'}">${unit.emoji}</div>
                    <div class="flex-1 overflow-hidden">
                        <div class="text-[10px] sm:text-xs font-bold truncate ${isUnlocked ? 'text-blue-300' : 'text-gray-300'}">${unit.name}</div>
                        ${isUnlocked ? `<div class="text-[8px] text-green-400">READY</div>` : `<div class="text-[8px] text-yellow-400 font-bold">üêæ ${unit.unlockCost}</div>`}
                    </div>`;
                
                const purchaseAction = (e) => {
                    e.preventDefault();
                    if (!isUnlocked && goldenPaws >= unit.unlockCost) {
                        goldenPaws -= unit.unlockCost;
                        unlockedTroops.push(idx);
                        saveGame();
                    }
                };
                btn.onclick = purchaseAction;
                btn.ontouchstart = purchaseAction;
                shopItemsContainer.appendChild(btn);
            });
        }

        function buildInGameUI() {
            unitControlsContainer.innerHTML = '';
            UNIT_TYPES.PLAYER.forEach((unit, idx) => {
                if (!unlockedTroops.includes(idx)) return;
                const btn = document.createElement('button');
                btn.id = `btn-unit-${idx}`;
                btn.className = "btn-game bg-blue-600 hover:bg-blue-500 border-b-4 border-blue-800 rounded-xl p-2 flex flex-col items-center min-w-[65px] sm:min-w-[90px] flex-shrink-0 shadow-lg";
                btn.innerHTML = `
                    <div class="text-xl sm:text-2xl mb-0.5">${unit.emoji}</div>
                    <div class="text-[8px] sm:text-[10px] text-blue-100 font-bold truncate w-full text-center mb-1">${unit.name}</div>
                    <div class="bg-black/50 px-1 rounded-lg text-[10px] sm:text-xs font-bold text-yellow-300">ü¶¥ ${unit.cost}</div>
                `;
                const spawnAction = (e) => { e.preventDefault(); spawnUnit(idx, false); };
                btn.onclick = spawnAction;
                btn.ontouchstart = spawnAction;
                unitControlsContainer.appendChild(btn);
            });
        }

        function spawnUnit(typeId, isEnemy) {
            const data = isEnemy ? UNIT_TYPES.ENEMY[typeId] : UNIT_TYPES.PLAYER[typeId];
            if (!isEnemy) {
                if (money >= data.cost) {
                    money -= data.cost;
                    units.push(new Unit(data, false));
                }
            } else {
                units.push(new Unit(data, true));
            }
        }

        function upgradeWorker() {
            if (money >= workerUpgradeCost) {
                money -= workerUpgradeCost;
                workerLevel++;
                moneyRate += 12 + (workerLevel * 6);
                maxMoney += 500;
                workerUpgradeCost = Math.floor(workerUpgradeCost * 1.6);
                spawnDamageText(GAME_WIDTH/2, 200, "ECONOMY BOOST", false, "#10b981");
            }
        }

        function spawnDamageText(x, y, amount, isPlayerDamage, color) {
            damageTexts.push(new DamageText(x, y, amount, isPlayerDamage, color));
        }

        function initGame() {
            money = 0; maxMoney = 250; moneyRate = 20; workerLevel = 1; workerUpgradeCost = 60;
            units = []; particles = []; damageTexts = []; gameTime = 0; enemySpawnTimer = 3;
            
            BASES.player.maxHp = 1000 + (currentLevel * 500); 
            BASES.player.hp = BASES.player.maxHp;
            
            BASES.enemy.maxHp = 1000 + (currentLevel * 2000); 
            if (currentLevel > 10) BASES.enemy.maxHp *= 2.5;
            if (currentLevel > 20) BASES.enemy.maxHp *= 3;
            if (currentLevel > 30) BASES.enemy.maxHp *= 4;
            if (currentLevel > 40) BASES.enemy.maxHp *= 5;

            if (currentLevel === 10) BASES.enemy.maxHp = 25000;
            if (currentLevel === 20) BASES.enemy.maxHp = 100000;
            if (currentLevel === 30) BASES.enemy.maxHp = 400000;
            if (currentLevel === 40) BASES.enemy.maxHp = 1500000;
            if (currentLevel === 50) BASES.enemy.maxHp = 10000000;
            
            BASES.enemy.hp = BASES.enemy.maxHp;
            
            buildInGameUI();
            gameState = 'PLAYING';
            screens.start.classList.add('hidden');
            screens.gameOver.classList.add('hidden');
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function updateLogic(dt) {
            if (gameState !== 'PLAYING') return;
            gameTime += dt;
            money = Math.min(maxMoney, money + moneyRate * dt);
            
            enemySpawnTimer -= dt;
            if (enemySpawnTimer <= 0) {
                let type = 0;
                if (currentLevel % 10 === 0) {
                    let bossId = 11 + (currentLevel / 10) - 1;
                    type = (gameTime < 8) ? bossId : getNormalEnemyId();
                } else {
                    type = getNormalEnemyId();
                }
                spawnUnit(type, true);
                
                let baseTimer = 4.5;
                if (currentLevel > 10) baseTimer = 3.5;
                if (currentLevel > 20) baseTimer = 2.8;
                if (currentLevel > 30) baseTimer = 2.2;
                if (currentLevel > 40) baseTimer = 1.6;
                enemySpawnTimer = Math.max(0.4, baseTimer - (gameTime / 180));
            }

            for (let i = units.length - 1; i >= 0; i--) {
                units[i].update(dt);
                if (units[i].hp <= 0) units.splice(i, 1);
            }
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update(dt);
                if (particles[i].life <= 0) particles.splice(i, 1);
            }
            for (let i = damageTexts.length - 1; i >= 0; i--) {
                damageTexts[i].update(dt);
                if (damageTexts[i].life <= 0) damageTexts.splice(i, 1);
            }

            if (BASES.player.hp <= 0) endGame(false);
            else if (BASES.enemy.hp <= 0) endGame(true);
            updateUI();
        }

        function getNormalEnemyId() {
            let pool = [0];
            if (currentLevel > 5) pool.push(1);
            if (currentLevel > 8) pool.push(2);
            if (currentLevel > 10) pool.push(3);
            if (currentLevel > 15) pool.push(4);
            if (currentLevel > 20) pool.push(5);
            if (currentLevel > 25) pool.push(6);
            if (currentLevel > 30) pool.push(7);
            if (currentLevel > 35) pool.push(8);
            if (currentLevel > 40) pool.push(9);
            if (currentLevel > 45) pool.push(10);
            return pool[Math.floor(Math.random() * pool.length)];
        }

        function drawBackground() {
            const grad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
            if (currentLevel <= 10) { grad.addColorStop(0, '#0c4a6e'); grad.addColorStop(1, '#0ea5e9'); }
            else if (currentLevel <= 20) { grad.addColorStop(0, '#111827'); grad.addColorStop(1, '#3b82f6'); }
            else if (currentLevel <= 30) { grad.addColorStop(0, '#450a0a'); grad.addColorStop(1, '#ef4444'); }
            else if (currentLevel <= 40) { grad.addColorStop(0, '#1e1b4b'); grad.addColorStop(1, '#8b5cf6'); }
            else { grad.addColorStop(0, '#000000'); grad.addColorStop(1, '#333333'); }

            ctx.fillStyle = grad; 
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            ctx.fillStyle = '#451a03'; ctx.fillRect(0, GROUND_Y, GAME_WIDTH, GAME_HEIGHT - GROUND_Y);
            ctx.fillStyle = '#166534'; ctx.fillRect(0, GROUND_Y, GAME_WIDTH, 25);
        }

        function drawBase(base) {
            ctx.font = `${base.width}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText(base.emoji, base.x + base.width/2, base.y + base.height/2);
            
            const hpP = base.hp / base.maxHp;
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.fillRect(base.x, base.y - 25, base.width, 12);
            ctx.fillStyle = base.isEnemy ? '#ef4444' : '#3b82f6';
            ctx.fillRect(base.x, base.y - 25, base.width * hpP, 12);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 1;
            ctx.strokeRect(base.x, base.y - 25, base.width, 12);
        }

        function render() {
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            drawBackground();
            drawBase(BASES.player);
            drawBase(BASES.enemy);
            units.sort((a,b) => a.y - b.y);
            for (let u of units) u.draw(ctx);
            for (let p of particles) p.draw(ctx);
            for (let d of damageTexts) d.draw(ctx);
        }

        function gameLoop(timestamp) {
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            if (dt < 0.1) { updateLogic(dt); render(); }
            if (gameState === 'PLAYING') requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            moneyDisplay.textContent = Math.floor(money);
            maxMoneyDisplay.textContent = maxMoney;
            workerLevelDisplay.textContent = workerLevel;
            upgradeCostDisplay.textContent = workerUpgradeCost;
            playerHpBar.style.width = `${(BASES.player.hp / BASES.player.maxHp) * 100}%`;
            enemyHpBar.style.width = `${(BASES.enemy.hp / BASES.enemy.maxHp) * 100}%`;
            btnUpgrade.disabled = money < workerUpgradeCost;
            UNIT_TYPES.PLAYER.forEach((u, i) => {
                const b = document.getElementById(`btn-unit-${i}`);
                if (b) b.disabled = money < u.cost;
            });
        }

        function endGame(won) {
            gameState = 'GAMEOVER';
            screens.gameOver.classList.remove('hidden');
            if (won) {
                let reward = currentLevel * 10;
                if (currentLevel % 10 === 0) reward = currentLevel * 40;
                if (currentLevel === 50) reward = 2500;
                
                goldenPaws += reward;
                screens.title.textContent = "VICTORY!";
                screens.title.className = "text-5xl sm:text-8xl font-bold mb-2 text-yellow-400 drop-shadow-2xl";
                screens.desc.innerHTML = `Area Secured. üêæ +${reward} Paws.<br><span class="text-sm sm:text-lg text-blue-300">New gear available in the barracks.</span>`;
                
                if (currentLevel < 50) currentLevel++;
                else screens.desc.innerHTML = "LEGENDARY PACK LEADER! Level 50 Complete.";
                saveGame();
            } else {
                screens.title.textContent = "DEFEAT!";
                screens.title.className = "text-5xl sm:text-8xl font-bold mb-2 text-red-600 drop-shadow-2xl";
                screens.desc.textContent = "The Dog House has fallen. Try upgrading!";
            }
        }

        // Attach events
        const startBtn = document.getElementById('btn-start');
        const startAction = (e) => { e.preventDefault(); initGame(); };
        startBtn.onclick = startAction;
        startBtn.ontouchstart = startAction;

        const restartBtn = document.getElementById('btn-restart');
        const restartAction = (e) => { 
            e.preventDefault();
            updateMenuUI(); gameState = 'START';
            screens.gameOver.classList.add('hidden'); screens.start.classList.remove('hidden');
        };
        restartBtn.onclick = restartAction;
        restartBtn.ontouchstart = restartAction;

        const upgradeAction = (e) => { e.preventDefault(); upgradeWorker(); };
        btnUpgrade.onclick = upgradeAction;
        btnUpgrade.ontouchstart = upgradeAction;

        updateMenuUI();
        drawBackground(); drawBase(BASES.player); drawBase(BASES.enemy);
    </script>
</body>
</html>